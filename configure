#!/usr/bin/env python3
"Collects .gir files from all around the system."

import argparse
import os
import shlex
from shutil import copyfile
from subprocess import check_output

PACKAGE_NAMES = [
    "gnome-shell",
    "mutter",
]
"Packages that export .gir files outside of /usr/share/gir-1.0"

def walk_copy_gir(root: str, destination: str):
    for dirpath, _, filenames in os.walk(root):
        for filename in filenames:
            if not filename.endswith(".gir"):
                continue
            source = os.path.join(dirpath, filename)
            dest = os.path.join(destination, filename)
            copyfile(source, dest)
            print(f"copied {source}")

def copy_gir(source: str, destination: str):
    dest = os.path.join(destination, os.path.basename(source))
    copyfile(source, dest)
    print(f"copied {source}")


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("-o", "--output", default="gir", help="Output directory for discovered .gir files")
    args = parser.parse_args()
    # autodiscover what we've got lying around
    walk_copy_gir("/usr/share/gir-1.0", args.output)
    # do the same for each package
    for name in PACKAGE_NAMES:
        rpm_qs = check_output(["rpm", "-qs", name]).decode('utf8')
        for line in rpm_qs.splitlines():
            if line.endswith(".gir"):
                copy_gir(line.lstrip("normal "), args.output)
                


if __name__ == "__main__":
    main()
